<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>MySQL Playground</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#303F9F">

  <!-- Web Application Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Tile color for Win8 -->
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PSK">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Polymer Starter Kit">
  <link rel="apple-touch-icon" href="images/touch/apple-touch-icon.png">

  <!-- Tile icon for Win8 (144x144) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js www/lib/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="../www/lib/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->
  <style is = "custom-style">
    /* Fix the toolbar height */
    #main-toolbar{
      height: var(--toolbar-height);
    }
    @media (min-width: 601px){
      #drawer.paper-drawer-panel > [drawer]:not([style-scope]):not(.style-scope){
        border-right: 0;
      }
    }
    #sideToolbar{
      padding: 0;
      margin: 0;
      height: calc(var(--toolbar-height) - 48px);
    }
    paper-drawer-panel {
      --paper-drawer-panel-left-drawer-container: {
        box-shadow: 0 3px 4px 0 rgba(0, 0, 0, 0.14),
                    0 1px 8px 0 rgba(0, 0, 0, 0.12),
                    0 3px 3px -2px rgba(0, 0, 0, 0.4);
      };
    }
    paper-tabs{
      background-color: var(--light-primary-color);
    }
    database-tables{
      height: 100%;
    }
    iron-pages{
      padding: 0;
      background-color: var(--app-background-color);
    }
    paper-item{
      cursor: pointer;
    }
  </style>
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>
  <template is="dom-bind" id="app">

    <!-- Add force-narrow to alwas have drawer closed -->
    <paper-drawer-panel id = "drawerPanel">
      <!-- Sidebar -->
      <paper-header-panel id = "sidePanel" drawer>
        <paper-toolbar id = "sideToolbar">
          <div class="title">Databases</div>
        </paper-toolbar>
        <paper-menu>
          <paper-menu>
            <iron-selector selected = "{{selectedDB}}" attr-for-selected="db">
              <template is="dom-repeat" items = "[[databases]]" as = "db">
                <paper-item db = "[[db]]" on-tap = "databaseSelected">
                  [[db]]
                  <paper-ripple></paper-ripple>
                </paper-item>
              </template>
            </iron-selector>
          </paper-menu>
        </paper-menu>
      </paper-header-panel>
      <!-- Main app -->
      <paper-scroll-header-panel class="flex" fixed main>
        <paper-toolbar class = "medium-tall" id = "main-toolbar">

          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="title">Mysql Playground - {{database}}</div>
          <paper-icon-button icon="info"      on-click="showAbout"></paper-icon-button>
          <paper-icon-button icon="refresh"   on-click="refresh"></paper-icon-button>
          <paper-icon-button icon="more-vert" on-click=""></paper-icon-button>

          <!-- Tabs bar -->
          <paper-tabs class = "bottom fit" selected="{{selected}}" attr-for-selected="name">
            <paper-tab name = "tables">Tables</paper-tab>
            <paper-tab name = "query">Query</paper-tab>
            <!-- <paper-tab name = "schema">Schema</paper-tab> -->
          </paper-tabs>

        </paper-toolbar>
        <!-- Actual app part -->

        <!-- This exposes the database connection to the rest of the elements -->
        <sql-connection id = "sql" connection = "{{connection}}"
                                   user = "{{user}}"
                                   password = "{{password}}"
                                   multipleStatements$="{{multipleStatements}}"
                                   database = "{{database}}">
                                   </sql-connection>

        <!-- <app-settings settings = "{{settings}}"></app-settings> -->

        <!-- Tabs of the application -->
        <iron-pages selected = "{{selected}}" attr-for-selected="name" class = "fit">
          <!-- Show all tables -->
          <database-tables id = "tables" name = "tables"
                                         connection = "{{connection}}"
                                         database = "{{database}}">
                                         </database-tables>
          <!-- Query the database -->
          <sql-query id = "query" name = "query" connection = "{{connection}}"></sql-query>
        </iron-pages>

      </paper-scroll-header-panel>

    </paper-drawer-panel>

    <script>
      // get the custom element
      let $scope = document.querySelector('#app');
      // Set which tab is selected
      $scope.selected = "tables";

      // settings
      // TODO: move this to an app-settings component
      $scope.user = 'root';
      $scope.password = 'root';
      $scope.multipleStatements = false;

      // Listen for the connected event
      $scope.$.sql.addEventListener('connected', (e) => {
        // Expose the mysql connection established in mysql-test
        // Now all components have their connection element defined
        $scope.connection = $scope.$.sql.getConnection();
        // Log some info
        console.log(`Connected to: ${e.detail.id}`);
        // Get the databases
        $scope.$.sql.connection.query('SHOW DATABASES', (err, rows, fields) => {
          if (err) throw err;
           // get all the databases
          $scope.databases = getEntries(rows);
          // set default database to the first one
          $scope.database = $scope.databases[0];
          // select the database in sql
          $scope.$.sql.selectDatabase($scope.database);
          // populate the tables in the tables tab
          $scope.$.tables.getTables();
        })
      });

      // when a table is clicked open a query
      $scope.$.tables.addEventListener('table-clicked', (e) => {
        console.log(e.detail.name);
      })

      // select the correct database based on the selection
      $scope.databaseSelected = function(e){
        // change the database
        $scope.$.sql.selectDatabase(e.model.db);
        // update the settings bindings
        $scope.database = e.model.db;
        $scope.$.drawerPanel.closeDrawer();
      }

      /** Execute a query and change to the query tab
        * @param query {String} Query to be executed
        **/
      $scope.executeQuery = function(query){
        // Query the database
        $scope.$.query.updateEditorContents(query);
        $scope.$.query.queryDatabase(query);
        // select the query tab
        this.selected = "query";
      }

      // helper function to get entries in result
      function getEntries(rows){
        let res = [];
        for (row in rows){
          res.push(rows[row]['Database']);
        }
        return res;
      }

    </script>

  </template>

  <!-- build:js scripts/app.js -->
  <script src="scripts/app.js"></script>
  <!-- endbuild-->
</body>

</html>
